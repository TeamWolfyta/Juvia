name: juvia
version: '3.8'

networks:
  pgadmin:
    name: pgadmin
  traefik:
    name: traefik

services:
  # ! ---------------------
  # ! WhoAmI
  # ! ---------------------
  whoami:
    image: traefik/whoami:v1.10.1
    labels:
      traefik.enable: true
      traefik.http.routers.whoami.entrypoints: https
      traefik.http.routers.whoami.rule: Host(`whoami.${DOMAIN:?}`)
    networks:
      - traefik
    restart: on-failure
  # ! ---------------------
  # ! PGAdmin
  # ! ---------------------
  pgadmin:
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:?}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:?}
    image: dpage/pgadmin4:7.6
    labels:
      traefik.enable: true
      traefik.http.routers.pgadmin.entrypoints: https
      traefik.http.routers.pgadmin.rule: Host(`pgadmin.${DOMAIN:?}`)
    networks:
      - pgadmin
      - traefik
    restart: on-failure
    user: root
    volumes:
      - /home/juvia/juvia/data/pgadmin:/var/lib/pgadmin
  # ! ---------------------
  # ! Portainer
  # ! ---------------------
  portainer:
    environment:
      PORTAINER_LICENSE_KEY: ${PORTAINER_LICENSE_KEY:?}
    image: portainer/portainer-ee:2.18.4
    labels:
      traefik.enable: true
      traefik.http.routers.portainer.entrypoints: https
      traefik.http.routers.portainer.rule: Host(`portainer.${DOMAIN:?}`)
      traefik.http.services.portainer.loadbalancer.server.port: 9000
    networks:
      - traefik
    restart: on-failure
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /home/juvia/juvia/data/portainer:/data
  # ! ---------------------
  # ! Traefik
  # ! ---------------------
  traefik:
    command:
      # Proivders
      - --providers.docker.exposedByDefault=false
      - --providers.docker.network=traefik
      # Entrypoints - HTTP
      - --entrypoints.http.address=:${TRAEFIK_HTTP_PORT:?}
      - --entrypoints.http.http.redirections.entrypoint.to=https
      - --entrypoints.http.http.redirections.entrypoint.scheme=https
      - --entrypoints.http.http.redirections.entrypoint.permanent=true
      # Entrypoints - HTTPS
      - --entrypoints.https.address=:${TRAEFIK_HTTPS_PORT:?}
      - --entrypoints.https.http.tls.certresolver=cloudflare
      - --entrypoints.https.http.tls.domains[0].main=${DOMAIN:?}
      - --entrypoints.https.http.tls.domains[0].sans=*.${DOMAIN:?}
      # Certresolvers - Cloudflare
      - --certificatesresolvers.cloudflare.acme.dnschallenge.provider=cloudflare
      - --certificatesresolvers.cloudflare.acme.email=${TRAEFIK_ACME_EMAIL:?}
      - --certificatesresolvers.cloudflare.acme.storage=/data/acme-cloudflare.json
      - --certificatesresolvers.cloudflare.acme.caserver=${TRAEFIK_ACME_CASERVER:?}
      # Logs
      - --log.level=WARN
      - --log.filePath=/logs/traefik.log
      - --accesslog=true
      - --accesslog.filepath=/logs/access.log
      # Dashboard
      - --ping
      - --api=true
      - --api.dashboard=true
      # Global
      - --global.checknewversion=false
      - --global.sendanonymoususage=false
    environment:
      CF_API_EMAIL: ${TRAEFIK_CLOUDFLARE_API_EMAIL:?}
      CF_DNS_API_TOKEN: ${TRAEFIK_CLOUDFLARE_API_TOKEN:?}
      CF_ZONE_API_TOKEN: ${TRAEFIK_CLOUDFLARE_API_TOKEN:?}
    image: traefik:v2.10.4
    labels:
      traefik.enable: true
      traefik.http.routers.traefik.rule: Host(`traefik.${DOMAIN:?}`)
      traefik.http.routers.traefik.service: api@internal
      traefik.http.routers.traefik.middlewares: traefik-auth@docker
      # Middleware
      traefik.http.middlewares.traefik-auth.basicauth.users: ${TRAEFIK_BASICAUTH_USERS:?}
      traefik.http.middlewares.traefik-auth.basicauth.removeHeader: true
    networks:
      - traefik
    ports:
      - ${TRAEFIK_HTTP_PORT:?}:${TRAEFIK_HTTP_PORT:?}
      - ${TRAEFIK_HTTPS_PORT:?}:${TRAEFIK_HTTPS_PORT:?}
    restart: on-failure
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /home/juvia/juvia/data/traefik:/data
      - /home/juvia/juvia/logs/traefik:/logs
